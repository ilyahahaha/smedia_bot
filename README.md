# SMedia Bot

Интерактивный user bot на основе Pyrogram.

### Используемый стэк:

- Python 3.11
- PostgreSQL (asyncpg driver)
- Pyrogram
- SQLAlchemy
- Alembic
- APScheduler
- Docker

------------

### Особенности реализации

- Применен Alembic для миграций измений базы данных
- Применен Docker для CI/CD
- Используемый планировщик сохраняет задачи в базу данных, что гарантирует выполнение задач даже после внеплановой
  остановки бота
- CLI для выполнения полезных функций и запуска бота
- Возможность повторно прогнать воронку, даже после получения триггера на остановку

------------

### Команды CLI

#### Генерация сессии для бота

Создает ключ сессии для бота.
!ОБЯЗАТЕЛЬНО ПЕРЕД ЗАПУСКОМ!

```
$ python main.py generate_session --id API ID ТЕЛЕГРАМ --hash API HASH ТЕЛЕГРАМ
AgGgkIoACV-Zf1eM9yVXu4jDynt7BzgoGZEQ1p8cqXzzgHoiqsbPXU172_r...
```

#### Миграция базы данных

Внести изменения из SQLAlchemy в базу данных.
!ОБЯЗАТЕЛЬНО ПЕРЕД ЗАПУСКОМ!

```
$ python main.py migrate
```

#### Запуск бота

Запустить бота.

```
$ python main.py start
```

------------

### Как запустить?

Предварительно создайте приложение для работы бота по адресу: https://my.telegram.org

#### Docker:
1. Клонируйте репозиторий.
2. Установите зависимости командой ```$ poetry install```
3. Сгенерируйте ключ для сессии.
4. Создайте .env файл по примеру из .env.example с необходимыми значениями окружения.
5. (по желанию) Поменяйте пароль от БД в docker-compose.yml
6. Соберите и запустите Docker контейнер.
7. Выполните в сервисе бота команду ```$ python main.py migrate``` для миграции изменений в БД.

#### Вне Docker:
1. Клонируйте репозиторий.
2. Установите зависимости командой ```$ poetry install```
3. Сгенерируйте ключ для сессии.
4. Создайте .env файл по примеру из .env.example с необходимыми значениями окружения.
5. Добавьте в созданный .env файл значение ```POSTGRES_URL=postgresql+asyncpg://username:password@127.0.0.1:5432/db``` с вашими данными от БД.
6. Выполните команду ```$ python main.py migrate``` для миграции изменений в БД.
7. Запустите бота командой ```$ python main.py start```.
